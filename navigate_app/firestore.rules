rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper functions
    // =========================================================================

    /// Check if the request is from an authenticated user
    function isAuthenticated() {
      return request.auth != null;
    }

    /// Get auth_mapping data for the current user
    function authData() {
      return get(/databases/$(database)/documents/auth_mapping/$(request.auth.uid)).data;
    }

    /// Get the app UID (personal number) of the current user
    function myAppUid() {
      return authData().appUid;
    }

    /// Get the role of the current user
    function myRole() {
      return authData().role;
    }

    /// Check if the current user is a developer or admin
    function isDeveloperOrAdmin() {
      let r = myRole();
      return r == 'developer' || r == 'admin';
    }

    /// Check if the given unitId is within the current user's unit scope
    function isInUnitScope(unitId) {
      return unitId in authData().allowedUnitScopeIds;
    }

    /// Check if the current user is a participant in the given navigation doc
    function isParticipant(navDoc) {
      return myAppUid() in navDoc.data.participants;
    }

    // =========================================================================
    // /auth_mapping/{uid} -- Firebase Auth UID -> App user mapping
    // =========================================================================
    match /auth_mapping/{uid} {
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }

    // =========================================================================
    // /users/{userId} -- User profiles
    // =========================================================================
    match /users/{uid} {
      allow read: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isInUnitScope(resource.data.unitId));
      allow create: if isAuthenticated() && myAppUid() == uid;
      allow update: if isAuthenticated() &&
        (myAppUid() == uid || isDeveloperOrAdmin() || isInUnitScope(resource.data.unitId));
      allow delete: if isAuthenticated() && isDeveloperOrAdmin();
    }

    // =========================================================================
    // /units/{unitId} -- Organizational units
    // =========================================================================
    match /units/{unitId} {
      allow read: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isInUnitScope(unitId));
      allow create, update, delete: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isInUnitScope(unitId));

      match /members/{memberId} {
        allow read, write: if isAuthenticated() &&
          (isDeveloperOrAdmin() || isInUnitScope(unitId));
      }
    }

    // =========================================================================
    // /areas/{areaId} -- Geographic areas (shared, all authenticated users)
    // =========================================================================
    match /areas/{areaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();

      match /layers_nz/{checkpointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_nb/{safetyPointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_gg/{boundaryId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_ba/{clusterId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
    }

    // =========================================================================
    // Flat legacy layer collections (backward compatibility)
    // =========================================================================
    match /layers_nz/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_nb/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_gg/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_ba/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /navigation_trees/{treeId} -- Navigation tree definitions
    // =========================================================================
    match /navigation_trees/{treeId} {
      allow read: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isInUnitScope(resource.data.unitId));
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isInUnitScope(resource.data.unitId));

      match /frameworks/{frameworkId} {
        allow read, write: if isAuthenticated();

        match /sub_frameworks/{subFrameworkId} {
          allow read, write: if isAuthenticated();
        }
      }
    }

    // Legacy collection name
    match /navigator_trees/{treeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /navigations/{navId} -- Navigation events (participant-scoped)
    // =========================================================================
    match /navigations/{navId} {
      allow read: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isParticipant(resource));
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        (isDeveloperOrAdmin() || isParticipant(resource));

      // All subcollections inherit parent navigation membership
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated() &&
          (isDeveloperOrAdmin() ||
           myAppUid() in get(/databases/$(database)/documents/navigations/$(navId)).data.participants);
        allow create, update, delete: if isAuthenticated() &&
          (isDeveloperOrAdmin() ||
           myAppUid() in get(/databases/$(database)/documents/navigations/$(navId)).data.participants);
      }
    }

    // =========================================================================
    // /rooms/{roomId} -- Voice message rooms (PTT / Walkie Talkie)
    // roomId = navigationId, so check navigation participants
    // =========================================================================
    match /rooms/{roomId} {
      allow read, write: if isAuthenticated() &&
        (isDeveloperOrAdmin() ||
         myAppUid() in get(/databases/$(database)/documents/navigations/$(roomId)).data.participants);

      match /messages/{messageId} {
        allow read, write: if isAuthenticated() &&
          (isDeveloperOrAdmin() ||
           myAppUid() in get(/databases/$(database)/documents/navigations/$(roomId)).data.participants);
      }
    }

    // =========================================================================
    // Legacy flat collections (backward compatibility)
    // =========================================================================
    match /navigation_tracks/{trackId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    match /navigation_approval/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /sync_metadata/{userId} -- Per-user sync state
    // =========================================================================
    match /sync_metadata/{uid} {
      allow read, write: if isAuthenticated();
    }
  }
}
