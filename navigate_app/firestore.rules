rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper functions
    // =========================================================================

    /// Check if the request is from an authenticated user
    function isAuthenticated() {
      return request.auth != null;
    }

    // =========================================================================
    // /users/{userId} -- User profiles
    // =========================================================================
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // =========================================================================
    // /units/{unitId} -- Organizational units
    // =========================================================================
    match /units/{unitId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();

      // ----- /units/{unitId}/members/{memberId} -----
      match /members/{memberId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
    }

    // =========================================================================
    // /areas/{areaId} -- Geographic areas
    // =========================================================================
    match /areas/{areaId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();

      match /layers_nz/{checkpointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_nb/{safetyPointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_gg/{boundaryId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /layers_ba/{clusterId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
    }

    // =========================================================================
    // Flat legacy layer collections (backward compatibility)
    // =========================================================================
    match /layers_nz/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_nb/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_gg/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    match /layers_ba/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /navigation_trees/{treeId} -- Navigation tree definitions
    // =========================================================================
    match /navigation_trees/{treeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();

      match /frameworks/{frameworkId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();

        match /sub_frameworks/{subFrameworkId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isAuthenticated();
        }
      }
    }

    // Legacy collection name
    match /navigator_trees/{treeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /navigations/{navId} -- Navigation events
    // =========================================================================
    match /navigations/{navId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();

      match /nav_layers_nz/{checkpointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /nav_layers_nb/{safetyPointId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /nav_layers_gg/{boundaryId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /nav_layers_ba/{clusterId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /routes/{navigatorId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /tracks/{trackId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /punches/{punchId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /alerts/{alertId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /violations/{violationId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /scores/{navigatorId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }

      match /system_status/{statusId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
    }

    // =========================================================================
    // /rooms/{roomId} -- Voice message rooms (PTT / Walkie Talkie)
    // =========================================================================
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();

      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated();
      }
    }

    // =========================================================================
    // Legacy flat collections
    // =========================================================================
    match /navigation_tracks/{trackId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    match /navigation_approval/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // /sync_metadata/{userId} -- Per-user sync state
    // =========================================================================
    match /sync_metadata/{uid} {
      allow read, write: if isAuthenticated();
    }
  }
}
