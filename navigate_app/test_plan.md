# תוכנית בדיקות — שיפור חלוקת נקודות (Regression Test Suite)

> ענף: `שיפור-חלוקת-נקודות`
> תאריך: 2026-02-15

---

## 1. בדיקות יחידה — ישויות (Domain Entities)

### 1.1 AssignedRoute

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 1.1.1 | `toMap()` ← `fromMap()` — סריאליזציה מלאה הלוך-חזור עם כל השדות (checkpointIds, routeLengthKm, sequence, startPointId, endPointId, waypointIds, status, approvalStatus, plannedPath, narrationEntries) | Unit | קריטי |
| 1.1.2 | `fromMap()` עם שדות חסרים — ברירות מחדל תקינות (status=optimal, approvalStatus=not_submitted, רשימות ריקות) | Unit | קריטי |
| 1.1.3 | `copyWith()` — עדכון חלקי של שדות, שאר השדות נשמרים | Unit | גבוה |
| 1.1.4 | `isApproved` getter — מחזיר `true` רק כאשר `approvalStatus == 'approved'` | Unit | בינוני |
| 1.1.5 | Equatable — שני אובייקטים עם אותם ערכים שווים, שינוי שדה אחד שובר שוויון | Unit | בינוני |
| 1.1.6 | `plannedPath` — סריאליזציה של רשימת `Coordinate` (lat/lng) דרך `toMap`/`fromMap` | Unit | גבוה |

### 1.2 DistributionResult

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 1.2.1 | `toMap()` ← `fromMap()` — סריאליזציה עם status=success, רשימת routes, ללא approvalOptions | Unit | קריטי |
| 1.2.2 | `toMap()` ← `fromMap()` — סריאליזציה עם status=needs_approval, כולל approvalOptions | Unit | קריטי |
| 1.2.3 | `hasSharedCheckpoints` / `sharedCheckpointCount` — חישוב נכון של נקודות משותפות | Unit | גבוה |
| 1.2.4 | `fromMap()` עם מפת routes ריקה — לא קורס | Unit | בינוני |

### 1.3 ApprovalOption

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 1.3.1 | סוג `expand_range` — שמירה/טעינה של expandedMin ו-expandedMax | Unit | גבוה |
| 1.3.2 | סוג `reduce_checkpoints` — שמירה/טעינה של reducedCount | Unit | גבוה |
| 1.3.3 | סוג `accept_best` — ללא פרמטרים נוספים | Unit | בינוני |

### 1.4 RouteLengthRange

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 1.4.1 | `toMap()` ← `fromMap()` — min ו-max נשמרים ונטענים | Unit | בינוני |
| 1.4.2 | ערכי ברירת מחדל תקינים | Unit | בינוני |

### 1.5 Navigation Entity — שדות חדשים

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 1.5.1 | `routesStage` — ברירת מחדל `'not_started'`, סריאליזציה תקינה | Unit | קריטי |
| 1.5.2 | `routesDistributed` — ברירת מחדל `false`, סריאליזציה תקינה | Unit | קריטי |
| 1.5.3 | `routes` — מפת `Map<String, AssignedRoute>` נשמרת ונטענת מ-JSON | Unit | קריטי |
| 1.5.4 | תאימות לאחור — `fromMap()` עם נתוני ניווט ישנים (ללא routesStage/routesDistributed) לא קורס | Unit | קריטי |

---

## 2. בדיקות יחידה — שירות חלוקת מסלולים (RoutesDistributionService)

### 2.1 ולידציה ותנאי סף

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.1.1 | שגיאה כאשר אין נקודות ביקורת (checkpoints ריק) | Unit | קריטי |
| 2.1.2 | שגיאה כאשר אין מנווטים (navigators ריק) | Unit | קריטי |
| 2.1.3 | שגיאה כאשר מספר הנקודות קטן ממספר המנווטים | Unit | גבוה |
| 2.1.4 | מינימום 2 נקודות ביקורת למנווט — ולידציה | Unit | גבוה |
| 2.1.5 | טווח אורך מסלול — min חייב להיות קטן מ-max | Unit | בינוני |

### 2.2 אלגוריתם מונטה קרלו — חלוקה ייחודית (Phase 1)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.2.1 | חלוקה עם מספיק נקודות — כל מנווט מקבל נקודות ייחודיות | Unit | קריטי |
| 2.2.2 | כל מנווט מקבל בדיוק את מספר הנקודות המבוקש (checkpointsPerNavigator) | Unit | קריטי |
| 2.2.3 | אורך כל מסלול בטווח [min, max] כאשר הנקודות מאפשרות זאת | Unit | קריטי |
| 2.2.4 | אופטימיזציית nearest-neighbor — סדר רציף עם executionOrder='sequential' | Unit | גבוה |
| 2.2.5 | 1000 איטרציות מקסימום — האלגוריתם עוצר בזמן סביר | Unit | גבוה |
| 2.2.6 | דיווח התקדמות (progress callback) — מספרי איטרציה עולים | Unit | בינוני |

### 2.3 אלגוריתם מונטה קרלו — חלוקה עם שיתוף (Phase 2)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.3.1 | כאשר אין מספיק נקודות ייחודיות — עובר לשיתוף נקודות | Unit | קריטי |
| 2.3.2 | נקודה משותפת חייבת להיות במיקום שונה ברצף של כל מנווט | Unit | קריטי |
| 2.3.3 | `hasSharedCheckpoints=true` ו-`sharedCheckpointCount` נכון בתוצאה | Unit | גבוה |
| 2.3.4 | Fallback — אם גם שיתוף נכשל, מחזיר `needs_approval` עם אפשרויות | Unit | גבוה |

### 2.4 פונקציות ניקוד (Scoring)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.4.1 | קריטריון `fairness` — חלוקה שווה מקבלת ציון גבוה יותר מחלוקה לא שווה | Unit | גבוה |
| 2.4.2 | קריטריון `midpoint` — מסלולים קרובים לאמצע הטווח מקבלים ציון גבוה | Unit | גבוה |
| 2.4.3 | קריטריון `uniqueness` — חלוקה ללא שיתוף מקבלת ציון גבוה יותר | Unit | גבוה |
| 2.4.4 | השוואת שתי חלוקות — הציון הגבוה נבחר | Unit | בינוני |

### 2.5 שילוב נקודות ציון (Waypoints)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.5.1 | הוספת waypoints אוטומטית לפי מרחק — נקודות ציון מוכנסות בין נקודות ביקורת | Unit | גבוה |
| 2.5.2 | הוספת waypoints לפי מיקום — נקודות ציון במיקום קבוע ברצף | Unit | גבוה |
| 2.5.3 | ללא waypoints — המסלול מכיל רק נקודות ביקורת | Unit | בינוני |
| 2.5.4 | חלוקה שוויונית של waypoints — כל מנווט מקבל מספר דומה | Unit | בינוני |

### 2.6 נקודת התחלה/סיום משותפת

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.6.1 | נקודת התחלה משותפת — כל המסלולים מתחילים מאותה נקודה | Unit | גבוה |
| 2.6.2 | נקודת סיום משותפת — כל המסלולים מסתיימים באותה נקודה | Unit | גבוה |
| 2.6.3 | ניווט כוכב (star) — נקודת התחלה = נקודת סיום | Unit | גבוה |
| 2.6.4 | ללא נקודות משותפות — כל מנווט מתחיל/מסיים בנקודות שונות | Unit | בינוני |

### 2.7 Swap אופטימיזציה מקומית

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.7.1 | `_trySwapToFitRange` — מסלול קצר מדי מקבל נקודה מרוחקת יותר | Unit | גבוה |
| 2.7.2 | `_trySwapToFitRange` — מסלול ארוך מדי מחליף לנקודה קרובה יותר | Unit | גבוה |
| 2.7.3 | Swap נכשל — לא משנה את המסלול המקורי | Unit | בינוני |

### 2.8 הרצה ב-Isolate

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 2.8.1 | `_runInIsolate` — מחזיר תוצאה תקינה בסיום | Unit | קריטי |
| 2.8.2 | סריאליזציה של `_DistributionParams` — כל הפרמטרים עוברים ל-Isolate | Unit | קריטי |
| 2.8.3 | `_parseIsolateResult` — המרת תוצאת Isolate ל-DistributionResult | Unit | גבוה |
| 2.8.4 | דיווח התקדמות מ-Isolate דרך SendPort | Unit | בינוני |

---

## 3. בדיקות ווידג'ט — מסכי UI

### 3.1 RoutesSetupScreen (מסך בחירת שיטת חלוקה)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 3.1.1 | מציג 3 אפשרויות: חלוקה אוטומטית, העלאת אקסל, בחירה ידנית | Widget | קריטי |
| 3.1.2 | לחיצה על "חלוקה אוטומטית" — מנווט ל-`RoutesAutomaticSetupScreen` | Widget | קריטי |
| 3.1.3 | לחיצה על "בחירה ידנית" — מנווט ל-`RoutesManualAppScreen` | Widget | קריטי |
| 3.1.4 | מציג מדריך שלבים (step indicator) עם 4 שלבים | Widget | בינוני |
| 3.1.5 | חזרה מ-screen ילד עם תוצאה — מעביר תוצאה להורה | Widget | גבוה |

### 3.2 RoutesAutomaticSetupScreen (חלוקה אוטומטית)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 3.2.1 | טעינת נתונים ראשונית — מציג spinner ולאחר מכן תוכן | Widget | קריטי |
| 3.2.2 | בורר סוג ניווט — מציג את כל הסוגים (רגיל, אשכולות, כוכב, הפוך, מצנח, מתפתח) | Widget | גבוה |
| 3.2.3 | סליידרים לטווח אורך — min/max מתעדכנים ומוצגים בק"מ | Widget | גבוה |
| 3.2.4 | בורר מספר נקודות למנווט — ולידציה של ערך מינימלי | Widget | גבוה |
| 3.2.5 | בורר קריטריון ניקוד — 3 אפשרויות (הגינות, אמצע, ייחודיות) | Widget | בינוני |
| 3.2.6 | בחירת נקודת התחלה — dropdown עם נקודות ביקורת | Widget | גבוה |
| 3.2.7 | בחירת נקודת סיום — dropdown עם נקודות ביקורת | Widget | גבוה |
| 3.2.8 | ניווט כוכב — נקודת סיום אוטומטית = נקודת התחלה | Widget | גבוה |
| 3.2.9 | לחיצה "הרץ חלוקה" — מציג progress indicator עם מספר איטרציה | Widget | קריטי |
| 3.2.10 | תוצאה מוצלחת — מנווט ל-RoutesVerificationScreen | Widget | קריטי |
| 3.2.11 | תוצאה `needs_approval` — מציג דיאלוג אישור עם אפשרויות | Widget | קריטי |
| 3.2.12 | דיאלוג אישור — אפשרות "הרחב טווח" מציגה ערכים חדשים | Widget | גבוה |
| 3.2.13 | דיאלוג אישור — אפשרות "הפחת נקודות" מציגה מספר מופחת | Widget | גבוה |
| 3.2.14 | דיאלוג אישור — אפשרות "קבל כמות שהוא" שומר את החלוקה הנוכחית | Widget | גבוה |
| 3.2.15 | Fallback טעינה — אם אין navCheckpoints, מנסה layer copy ואז area checkpoints | Widget | גבוה |
| 3.2.16 | שגיאת טעינה — מציג הודעת שגיאה מתאימה | Widget | בינוני |

### 3.3 RoutesManualAppScreen (חלוקה ידנית באפליקציה)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 3.3.1 | רשימת מנווטים — מציג את כל המנווטים הנבחרים עם כפתורי הרחבה | Widget | קריטי |
| 3.3.2 | בורר נקודת התחלה משותפת — dropdown עם כל הנקודות | Widget | גבוה |
| 3.3.3 | בורר נקודת סיום משותפת — dropdown עם כל הנקודות | Widget | גבוה |
| 3.3.4 | בחירת נקודות למנווט — פתיחת bottom sheet עם רשימת נקודות | Widget | קריטי |
| 3.3.5 | bottom sheet — checkbox multi-select עם סימון ויזואלי | Widget | גבוה |
| 3.3.6 | נקודה כבר משויכת — תג כתום עם שם המנווט שאליו משויכת | Widget | גבוה |
| 3.3.7 | תצוגת מפה — מסלול מוצג עם קווים וסמנים צבעוניים | Widget | גבוה |
| 3.3.8 | אורך מסלול — מחושב ומוצג בק"מ לכל מנווט | Widget | גבוה |
| 3.3.9 | סטטוס מסלול — תג ויזואלי (optimal/too_short/too_long) | Widget | גבוה |
| 3.3.10 | ולידציה לפני שמירה — מנווט ללא נקודות → שגיאה | Widget | קריטי |
| 3.3.11 | שמירה ומעבר — שומר ומנווט ל-RoutesVerificationScreen | Widget | קריטי |
| 3.3.12 | תצוגת כל המסלולים / מסלול בודד — toggle button | Widget | בינוני |

### 3.4 RoutesVerificationScreen (אימות מסלולים)

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 3.4.1 | שתי לשוניות — מפה וטבלה | Widget | קריטי |
| 3.4.2 | לשונית מפה — מציגה polylines אדומים למסלולים | Widget | גבוה |
| 3.4.3 | לשונית טבלה — רשימת מסלולים עם אורך וסטטוס | Widget | גבוה |
| 3.4.4 | פקדי שכבות — toggle ל-GG, NZ, NB, Routes, Waypoints | Widget | גבוה |
| 3.4.5 | סליידר שקיפות — שינוי opacity לכל שכבה | Widget | בינוני |
| 3.4.6 | סינון לפי מנווט — בחירת מנווט מציגה רק את המסלול שלו | Widget | גבוה |
| 3.4.7 | נקודות משותפות — מסומנות בכתום על המפה | Widget | בינוני |
| 3.4.8 | כפתור "סיים אימות" — מציג דיאלוג אישור | Widget | קריטי |
| 3.4.9 | אישור סיום — עדכון `routesStage: 'ready'` ושמירה | Widget | קריטי |
| 3.4.10 | חזרה ל-NavigationPreparationScreen עם תוצאה | Widget | גבוה |
| 3.4.11 | spinner במהלך שמירה — loading indicator פעיל | Widget | בינוני |

---

## 4. בדיקות אינטגרציה — זרימת עבודה

### 4.1 זרימה מלאה — חלוקה אוטומטית

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 4.1.1 | יצירת ניווט → הגדרת נקודות → חלוקה אוטומטית → אימות → סיום | Integration | קריטי |
| 4.1.2 | `routesStage` מתקדם: `not_started` → `setup` → `verification` → `ready` | Integration | קריטי |
| 4.1.3 | `routesDistributed` הופך ל-`true` לאחר חלוקה מוצלחת | Integration | קריטי |
| 4.1.4 | שמירת routes ב-Navigation entity ושחזור לאחר סגירה/פתיחה | Integration | קריטי |

### 4.2 זרימה מלאה — חלוקה ידנית

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 4.2.1 | יצירת ניווט → בחירה ידנית → הגדרת נקודות לכל מנווט → אימות → סיום | Integration | קריטי |
| 4.2.2 | נקודות ידניות נשמרות כ-AssignedRoute עם כל השדות | Integration | גבוה |
| 4.2.3 | waypoints מחולקים באופן שוויוני בין מנווטים | Integration | גבוה |

### 4.3 מצבי קצה וטיפול בשגיאות

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 4.3.1 | מנווט יחיד — חלוקה תקינה עם כל הנקודות | Integration | גבוה |
| 4.3.2 | הרבה מנווטים, מעט נקודות — fallback לשיתוף נקודות | Integration | גבוה |
| 4.3.3 | טווח אורך בלתי אפשרי (min גבוה מסך כל המרחקים) — הודעת שגיאה | Integration | גבוה |
| 4.3.4 | ביטול באמצע חלוקה — חזרה למסך הקודם ללא שינויים | Integration | בינוני |
| 4.3.5 | נתוני נקודות ביקורת חסרים — fallback ל-layer copy ואז area | Integration | גבוה |
| 4.3.6 | חזרה אחורה מאימות — routesStage לא משתנה ל-ready | Integration | בינוני |

### 4.4 תאימות לאחור

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 4.4.1 | ניווט ישן (ללא routesStage/routesDistributed) נטען בהצלחה | Integration | קריטי |
| 4.4.2 | ניווט ישן עם routes בפורמט ישן — ממיר ל-AssignedRoute | Integration | קריטי |
| 4.4.3 | סנכרון Firestore — routes Map נשמר ונטען עם jsonEncode/Decode | Integration | קריטי |

---

## 5. בדיקות מסך ניהול ותחקיר

### 5.1 NavigationManagementScreen

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 5.1.1 | הצגת סטטוס חלוקת מסלולים בסקירת הניווט | Widget | בינוני |
| 5.1.2 | כפתור מעבר לניהול מסלולים — מנווט למסך המתאים | Widget | בינוני |

### 5.2 NavigationsListScreen

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 5.2.1 | רשימת ניווטים — מציגה אינדיקטור routes_ready/routes_pending | Widget | בינוני |
| 5.2.2 | סינון לפי תת-מסגרת — מראה רק ניווטים רלוונטיים | Widget | בינוני |

### 5.3 InvestigationScreen

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 5.3.1 | פרופיל מהירות — גרף מוצג ללא קריסה | Widget | גבוה |
| 5.3.2 | Playback מסלול — ווידג'ט הפעלה מוצג | Widget | גבוה |
| 5.3.3 | Heatmap מנווטים — שכבת חום מוצגת על המפה | Widget | בינוני |
| 5.3.4 | השוואת מנווטים — ווידג'ט השוואה מוצג | Widget | בינוני |
| 5.3.5 | ניתוח סטיות — נתוני סטייה מחושבים ומוצגים | Widget | בינוני |
| 5.3.6 | ייצוא תמונת מפה — פונקציית export לא קורסת | Widget | בינוני |

---

## 6. בדיקות CreateNavigationScreen

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 6.1 | שמירת navigation עם routesStage/routesDistributed — שדות נשמרים | Widget | קריטי |
| 6.2 | עריכת navigation קיים — routes ו-routesStage נשמרים ולא נדרסים | Widget | קריטי |
| 6.3 | מעבר ממסך יצירה למסך הגדרת מסלולים — ניווט תקין | Widget | גבוה |

---

## 7. בדיקות ביצועים

| # | תיאור הבדיקה | סוג | עדיפות |
|---|-------------|-----|--------|
| 7.1 | חלוקה אוטומטית עם 50 נקודות ו-10 מנווטים — מסתיימת תוך 30 שניות | Performance | גבוה |
| 7.2 | חלוקה אוטומטית עם 100 נקודות ו-20 מנווטים — מסתיימת תוך 60 שניות | Performance | בינוני |
| 7.3 | הרצת Isolate לא חוסמת את ה-UI (main thread) | Performance | קריטי |
| 7.4 | תצוגת מפה עם 20 מסלולים — רינדור ללא lag | Performance | גבוה |

---

## 8. סיכום סטטיסטי

| קטגוריה | מספר בדיקות | קריטי | גבוה | בינוני |
|---------|-----------|-------|------|--------|
| ישויות (Domain) | 18 | 7 | 5 | 6 |
| שירות חלוקה (Service) | 26 | 7 | 14 | 5 |
| מסכי UI (Widgets) | 35 | 12 | 15 | 8 |
| אינטגרציה (Integration) | 13 | 7 | 4 | 2 |
| ניהול ותחקיר | 8 | 0 | 2 | 6 |
| יצירת ניווט | 3 | 2 | 1 | 0 |
| ביצועים | 4 | 1 | 2 | 1 |
| **סה"כ** | **107** | **36** | **43** | **28** |

---

## 9. קבצי בדיקה מומלצים

```
test/
├── domain/
│   └── entities/
│       ├── assigned_route_test.dart        # 1.1.x
│       ├── distribution_result_test.dart   # 1.2.x, 1.3.x, 1.4.x
│       └── navigation_routes_test.dart     # 1.5.x
├── services/
│   └── routes_distribution_service_test.dart  # 2.x (all service tests)
├── presentation/
│   └── screens/
│       └── navigations/
│           ├── routes_setup_screen_test.dart           # 3.1.x
│           ├── routes_automatic_setup_screen_test.dart # 3.2.x
│           ├── routes_manual_app_screen_test.dart      # 3.3.x
│           ├── routes_verification_screen_test.dart    # 3.4.x
│           ├── navigation_management_screen_test.dart  # 5.1.x
│           ├── navigations_list_screen_test.dart       # 5.2.x
│           ├── investigation_screen_test.dart          # 5.3.x
│           └── create_navigation_screen_test.dart      # 6.x
└── integration/
    ├── routes_workflow_test.dart            # 4.1.x, 4.2.x
    ├── routes_edge_cases_test.dart          # 4.3.x
    ├── routes_backward_compat_test.dart     # 4.4.x
    └── routes_performance_test.dart         # 7.x
```

---

## 10. הערות ליישום

1. **Mock של RoutesDistributionService** — ניתן ליצור mock שמחזיר תוצאות קבועות לבדיקות UI
2. **Isolate בבדיקות** — יש להשתמש ב-`compute` במקום `Isolate.spawn` ישיר לצורך בדיקתיות
3. **GeometryUtils** — מומלץ לבדוק חישובי מרחק בנפרד (unit tests טהורים)
4. **RTL** — בבדיקות widget יש לוודא `Directionality.rtl` ב-tester
5. **Drift DB Mock** — להשתמש ב-in-memory database לבדיקות אינטגרציה
